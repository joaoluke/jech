#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <stdbool.h>
#include "core/vm.h"
#include "errors/error.h"

#define MAX_VARS 64

/**
 * Variable table for `keep` instruction
 */
typedef struct
{
	char name[MAX_STRING];
	char value[MAX_STRING];
} JechVariable;

static JechVariable variables[MAX_VARS];
static int var_count = 0;

/**
 * Sets or updates a variable in the runtime environment
 */
static void set_variable(const char *name, const char *value)
{
	for (int i = 0; i < var_count; i++)
	{
		if (strcmp(variables[i].name, name) == 0)
		{
			strncpy(variables[i].value, value, MAX_STRING);
			return;
		}
	}
	if (var_count < MAX_VARS)
	{
		strncpy(variables[var_count].name, name, MAX_STRING);
		strncpy(variables[var_count].value, value, MAX_STRING);
		var_count++;
	}
}

/**
 * Retrieves the value of a variable by name
 */
static const char *get_variable(const char *name)
{
	for (int i = 0; i < var_count; i++)
	{
		if (strcmp(variables[i].name, name) == 0)
		{
			return variables[i].value;
		}
	}
	return NULL;
}

/**
 * Debug function to print all variables in the VM
 */
void _debug_vm_dump_vars()
{
	extern JechVariable variables[];
	extern int var_count;

	for (int i = 0; i < var_count; i++)
	{
		printf("Variable: %s = %s\n", variables[i].name, variables[i].value);
	}
}

/**
 * Checks if a variable exists in the runtime environment
 */
bool variable_exists(const char *name)
{
	for (int i = 0; i < var_count; i++)
	{
		if (strcmp(variables[i].name, name) == 0)
		{
			return true;
		}
	}
	return false;
}

/**
 * Executes the bytecode generated by the compiler
 */
void _JechVM_Execute(const Bytecode *bc)
{
	for (int i = 0; i < bc->count; i++)
	{
		Instruction inst = bc->instructions[i];

		switch (inst.op)
		{
		case OP_SAY:
			if (inst.token_type == TOKEN_IDENTIFIER)
			{
				const char *value = get_variable(inst.operand);
				if (value)
					printf("%s\n", value);
				else
					fprintf(stderr, "Runtime error: undefined variable '%s'\n", inst.operand);
			}
			else
			{
				printf("%s\n", inst.operand);
			}
			break;
		case OP_KEEP:
			if (get_variable(inst.name) != NULL)
			{
				report_runtime_error("Variable already declared", inst.line, inst.column);
				exit(1);
			}
			set_variable(inst.name, inst.operand);
			break;
		case OP_ASSIGN:
			if (variable_exists(inst.name))
			{
				set_variable(inst.name, inst.operand);
			}
			else
			{
				report_runtime_error("Cannot assign to undeclared variable", 0, 0);
				exit(1);
			}
			break;
		case OP_END:
			return;
		default:
			fprintf(stderr, "VM error: unknown opcode %d\n", inst.op);
			return;
		}
	}
}
